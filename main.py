from config import bot_token
import telebot 
from requests import get
import sqlite3
from telebot import types
from db.db import Users, get_users, generate_tokens, check_inspection, check_dislike, dislike, get_name, stop_dialogue, check_register, check_islike, find_friend, get_user_invites, is_matching, like, user_registration, user_arr, start_dial, cur_dial_find, new_message_add, check_invite, UsersAndDialogs, Messages, Inspections, Invites
import os

last_like = {}
global_dict = {}
url_number = 1
bot = telebot.TeleBot(bot_token)
register_dict = {}
admin_list = [785704774, 197942998]


@bot.message_handler(commands=['sendmessage'])
def send_message(message):
    if message.chat.id in admin_list:
        mesg = bot.send_message(message.chat.id, '–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏')
        bot.register_next_step_handler(mesg, send_message_1)
    else:
        bot.send_message(message.chat.id, '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã')


def send_message_1(message):
    try:
        if message.photo:
            raw = message.photo[2].file_id
            name = raw+".jpg"
            file_info = bot.get_file(raw)
            downloaded_file = bot.download_file(file_info.file_path)
            
            with open(name,'wb') as new_file:
                new_file.write(downloaded_file)
            with open (name, 'rb') as file: 
                for user_id in get_users():
                    bot.send_photo(user_id, photo=types.InputMediaPhoto(file), caption=message.caption)
            os.remove(name)
        else:
            for user_id in get_users():
                bot.send_message(user_id, text=message.text)
        bot.send_message(message.chat.id, '–°–æ–æ–±—â–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã')
    except: 
        bot.send_message(message.chat.id, '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –≤–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –æ–Ω–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º')

@bot.message_handler(commands=['getinvite'])
def getinvite(message):
    if check_register(message.chat.id):
        arr = get_user_invites(message.chat.id)
        if len(arr) != 0:
            bot.send_message(message.chat.id, '–í–∞—à–∏ –∏–Ω–≤–∞–π—Ç—ã:')
            for elem in arr:
                bot.send_message(message.chat.id, f'{elem}')
        else:
            bot.send_message(message.chat.id, '–í–∞—à–∏ –∏–Ω–≤–∞–π—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.')
        # joinarr = "\n".join(arr)
        # bot.send_message(message.chat.id, f'–í–∞—à–∏ –∏–Ω–≤–∞–π—Ç—ã \n{joinarr}')
    else:
        bot.send_message(message.chat.id, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")


@bot.message_handler(commands=['start'])
def check_token(message):
    if check_register(message.chat.id):
        bot.send_message(message.chat.id, '–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã')
    else:
        mesg = bot.send_message(message.chat.id, '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∏–Ω–≤–∞–π—Ç-–∫–æ–¥:', )
        bot.register_next_step_handler(mesg, start)
        
@bot.message_handler(commands=['continue'])
def contin(message):
    if check_register(message.chat.id):
        keyb = types.InlineKeyboardMarkup(row_width=1)
        butt = types.InlineKeyboardButton(text='–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è', callback_data='startwatching')
        keyb.add(butt)
        bot.send_message(message.chat.id, '–ü—Ä–æ–¥–æ–ª–∂–∏–º –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è?', reply_markup=keyb)
    else:
        bot.send_message(message.chat.id, '–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã')

@bot.message_handler(commands=['ismatchs'])
def ismatchhing(message):
    if check_register(message.chat.id):
        if not cur_dial_find(message.chat.id):
            kob = types.InlineKeyboardMarkup(row_width=2)
            arr = is_matching(message.chat.id)
            txt = ''
            print(0)
            if arr:     
                for elem in arr:
                    kob = types.InlineKeyboardMarkup(row_width=2)
                    kob.add(types.InlineKeyboardButton(text=f'{elem[1]}', callback_data=f'suggdial/{message.chat.id}/{elem[0]}'))
                    txt = elem[1] 
                    bot.send_message(message.chat.id, txt, reply_markup=kob, parse_mode='Markdown')

            else:
                bot.send_message(message.chat.id, '–í–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ')
        else:
            bot.send_message(message.chat.id, '–í—ã —É–∂–µ –≤–µ–¥–µ—Ç–µ –¥–∏–∞–ª–æ–≥')
    else:
        bot.send_message(message.chat.id, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")


def start(message):
    i = check_invite(message.text, message.chat.id)
    if i == 1:
        bot.send_message(message.chat.id, '–í–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞: https://youtu.be/py3y6-Nw6yc')
        keyb = types.InlineKeyboardMarkup()
        reg_button = types.InlineKeyboardButton(text='–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', callback_data='reg')
        keyb.add(reg_button)
        with open('rules.docx', 'rb') as file:
            bot.send_document(message.chat.id, file)
            
        
        with open('politics.docx', 'rb') as file:
            bot.send_document(message.chat.id, file)

        bot.send_message(message.chat.id, '–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—Å—è —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', reply_markup=keyb)
    elif i == -1:
        mesg = bot.send_message(message.chat.id, '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–≤–∞–π—Ç-–∫–æ–¥')
        bot.register_next_step_handler(mesg, start)
    else:
        mesg = bot.send_message(message.chat.id, '–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω')
        bot.register_next_step_handler(mesg, start)




        
 

@bot.callback_query_handler(func=lambda call: True)
def callback_inline(call):
    if call.message:
        if call.data == "reg":
            global global_dict
            global register_dict
            
            if call.message.chat.id in global_dict:
                bot.send_message(call.message.chat.id, '–í—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é')
                bot.answer_callback_query(callback_query_id=call.id)
            elif call.message.chat.id in register_dict:
                bot.send_message(call.message.chat.id, '–í—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é')
                bot.answer_callback_query(callback_query_id=call.id)

            else:
                
                mesg = bot.send_message(call.message.chat.id, '–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é:')
                register_dict.update({call.message.chat.id: 1})
                bot.register_next_step_handler(mesg, reg)
                bot.answer_callback_query(callback_query_id=call.id)

        elif call.data == "startwatching":
            bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)
            u2 = find_friend(call.message.chat.id)
            print(call.message.chat.id)

            if u2:
                filepath = u2[2]

                kb = types.InlineKeyboardMarkup(row_width=2)
                like_button = types.InlineKeyboardButton(text='ü§ù', callback_data=f'like/{str(u2[0])}')

                dislike_button = types.InlineKeyboardButton(text='‚õîÔ∏è', callback_data=f'dislike/{str(u2[0])}')
                kb.add(like_button, dislike_button)
                # see_matchs = types.InlineKeyboardButton(text='–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏', callback_data='ismatchs')
                # kb.add(see_matchs)
                last_like.update({call.message.chat.id: u2[0]})
                print(u2)
                bot.send_photo(call.message.chat.id, open(f'{filepath}', 'rb'), caption=f'_{u2[1]}, {u2[4]}_ \n{u2[3]}', reply_markup=kb, parse_mode='Markdown')
            else:
                bot.send_message(call.message.chat.id, '—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å')
        elif call.data.split('/')[0] == 'like':

            bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)
            if not check_islike(call.message.chat.id, int(call.data.split('/')[-1])):
                like(call.message.chat.id, int(call.data.split('/')[-1]))

            else:
                bot.send_message(call.message.chat.id, '–í—ã —É–∂–µ –ª–∞–π–∫–∞–ª–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')
                bot.answer_callback_query(callback_query_id=call.id)
            u2 = find_friend(call.message.chat.id)
            if u2:
                filepath = u2[2]
                kb = types.InlineKeyboardMarkup(row_width=2)
                like_button = types.InlineKeyboardButton(text='ü§ù', callback_data=f'like/{str(u2[0])}')

                dislike_button = types.InlineKeyboardButton(text='‚õîÔ∏è', callback_data=f'dislike/{str(u2[0])}')
                kb.add(like_button, dislike_button)
                # see_matchs = types.InlineKeyboardButton(text='–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏', callback_data='ismatchs')
                # kb.add(see_matchs)
            


                print(u2)
                bot.send_photo(call.message.chat.id, open(f'{filepath}', 'rb'), caption=f'{u2[1]}, {u2[4]} \n{u2[3]}', reply_markup=kb)
                bot.answer_callback_query(callback_query_id=call.id)
            else:
                bot.send_message(call.message.chat.id, '—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å')
                bot.answer_callback_query(callback_query_id=call.id)
        elif call.data.split('/')[0] == 'dislike':
            bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)
            if not check_dislike(call.message.chat.id, int(call.data.split('/')[-1])):
                dislike(call.message.chat.id, int(call.data.split('/')[-1]))
            
            u2 = find_friend(call.message.chat.id)
            if u2:
                filepath = u2[2]
                kb = types.InlineKeyboardMarkup(row_width=2)
                like_button = types.InlineKeyboardButton(text='ü§ù', callback_data=f'like/{str(u2[0])}')

                
                dislike_button = types.InlineKeyboardButton(text='‚õîÔ∏è', callback_data=f'dislike/{str(u2[0])}')
                kb.add(like_button, dislike_button)
                # see_matchs = types.InlineKeyboardButton(text='–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏', callback_data='ismatchs')
                # kb.add(see_matchs)
                

                last_like.update({call.message.chat.id: u2[0]})
                print(u2)
                bot.send_photo(call.message.chat.id, open(f'{filepath}', 'rb'), caption=f'{u2[1]}, {u2[4]} \n{u2[3]}', reply_markup=kb)
                bot.answer_callback_query(callback_query_id=call.id)
            else:
                bot.send_message(call.message.chat.id, '—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å')
                bot.answer_callback_query(callback_query_id=call.id)
        # elif call.data == 'ismatchs':
        #     bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)
        #     kob = types.InlineKeyboardMarkup(row_width=1)
        #     arr = is_matching(call.message.chat.id)
        #     txt = ''
        #     print(0)
        #     if arr:
        #         for elem in arr:
        #             kob.add(types.InlineKeyboardButton(text=f'{elem[1]}', callback_data=f'suggdial/{call.message.chat.id}/{elem[0]}'))
        #             txt = txt + elem[1] + '\n'
        #         bot.send_message(call.message.chat.id, f'–°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤: {txt}', reply_markup=kob)
        #         bot.answer_callback_query(callback_query_id=call.id)
        #     else:
        #         bot.send_message(call.message.chat.id, '–í–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ')
        #         bot.answer_callback_query(callback_query_id=call.id)
        elif call.data.split('/')[0] == 'suggdial':
            bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)
            arr = call.data.split('/')
            kb = types.InlineKeyboardMarkup()
            button = types.InlineKeyboardButton(text='–ù–∞—á–∞—Ç—å', callback_data=f'{arr[1]}')
            kb.add(button)
            bot.send_message(int(call.data.split('/')[2]), f'–° –≤–∞–º–∏ —Ö–æ—á–µ—Ç –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {get_name(int(arr[1]))}', reply_markup=kb)
            bot.send_message(call.message.chat.id, '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞')
            bot.answer_callback_query(callback_query_id=call.id)
        
        elif call.data.split('/')[0] == 'ismatchs':
            if not cur_dial_find(call.message.chat.id):
                kob = types.InlineKeyboardMarkup()
                arr = is_matching(call.message.chat.id)
                txt = ''
                
                print(0)
                num = int(call.data.split("/")[1]) 
                if arr:
                    if len(arr) > (num+1) * 5:
                        kob.add(types.InlineKeyboardButton(text=f'->', callback_data=f'ismatchs/{int(call.data.split("/")[1]) + 1}'))
                    if num > 0:
                        kob.add(types.InlineKeyboardButton(text=f'<-', callback_data=f'ismatchs/{int(call.data.split("/")[1]) - 1}'))
                    
                    
                    arr = arr[num*5:(num+1)*5]
                    

                    for elem in arr:
                        kob.add(types.InlineKeyboardButton(text=f'{elem[1]}', callback_data=f'suggdial/{call.message.chat.id}/{elem[0]}'))
                        txt = txt + elem[1] + '\n'
                    bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=kob)
                    bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=f'_–°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤_:\n{txt}', parse_mode='Markdown')
                    bot.answer_callback_query(callback_query_id=call.id)
    

        


        if call.data.isdigit():
            if call.data in user_arr():
                if not cur_dial_find(call.message.chat.id):
                    start_dial(call.message.chat.id, int(call.data))
                    bot.send_message(call.message.chat.id, f'–í—ã –Ω–∞—á–∞–ª–∏ –¥–∏–∞–ª–æ–≥ —Å {get_name(int(call.data))}')
                    bot.send_message(int(call.data), f'–° –≤–∞–º–∏ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {get_name(call.message.chat.id)}')
                    bot.answer_callback_query(callback_query_id=call.id)
                else:
                    bot.send_message(call.message.chat.id, '–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–∂–Ω–æ –≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –¥–∏–∞–ª–æ–≥')
                    bot.answer_callback_query(callback_query_id=call.id)
                    




def reg(message):
    global global_dict
    username = message.text

    global_dict.update({message.chat.id: [username]})
    mesg = bot.send_message(message.chat.id, '–°–∫–æ–ª—å–∫–æ –≤–∞–º –ª–µ—Ç?')
    bot.register_next_step_handler(mesg, reg1)

def reg1(message):
    global global_dict
    try:
        age = int(message.text)
        global_dict[message.chat.id].append(age)
        mesg = bot.send_message(message.chat.id, '–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é:')
        bot.register_next_step_handler(mesg, reg2)
    except:
        mesg = bot.send_message(message.chat.id, '–í–æ–∑—Ä–∞—Å—Ç –≤–≤–µ–¥–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤–≤–µ–¥–∏—Ç–µ –µ—â–µ —Ä–∞–∑, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã')
        bot.register_next_step_handler(mesg, reg1)



def reg2(message):
    global global_dict
    try:
        file_id = message.photo[-1].file_id
        file_info = bot.get_file(file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        src = f'{file_info.file_path}'
        with open(src, 'wb') as new_file:
            new_file.write(downloaded_file)
        global_dict[message.chat.id].append(src)
        mesg = bot.send_message(message.chat.id, "–ê —Å–µ–π—á–∞—Å –¥–∞–≤–∞–π—Ç–µ –¥–æ–±–∞–≤–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ:")
        bot.register_next_step_handler(mesg, reg3)
    except:
        mesg = bot.send_message(message.chat.id, '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â–µ —Ä–∞–∑')
        bot.register_next_step_handler(mesg, reg2)

def reg3(message):
    global global_dict
    about = message.text
    global_dict[message.chat.id].append(about)

    with open(f'{message.chat.id}.txt', 'w') as f:
        f.write(f'–§–∞–π–ª —Å –ø–µ—Ä–µ–ø–∏—Å–∫–∞–º–∏ {global_dict[message.chat.id][0]}')


    
    global_dict[message.chat.id].append(f'{message.chat.id}.txt')
    
    mesg = bot.send_message(message.chat.id, '–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–Ω—Å–ø–µ–∫—Ü–∏–∏ (—Å—Ç—Ä–æ–≥–æ 4 —Ü–∏—Ñ—Ä—ã):')

    bot.register_next_step_handler(mesg, reg4)
    # bot.send_photo(message.chat.id, photo_link, caption=f'{username} \n{about}', reply_markup=kb)


def reg4(message):
    global global_dict

    inspection_number = message.text
    if check_inspection(inspection_number):


        global_dict[message.chat.id].append(inspection_number)
        user_registration(message.chat.id, global_dict[message.chat.id])
        keyb = types.InlineKeyboardMarkup(row_width=1)
        butt = types.InlineKeyboardButton(text='–ù–∞—á–∞—Ç—å –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è', callback_data='startwatching')
        # keyb = types.ReplyKeyboardMarkup(one_time_keyboard=True)
        # butt = types.KeyboardButton(text='–ù–∞—á–∞—Ç—å –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è')
        keyb.add(butt)
        bot.send_message(message.chat.id, '–ù–∞—á–Ω–µ–º?', reply_markup=keyb)
    else:
        mesg = bot.send_message(message.chat.id, '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∏–Ω—Å–ø–µ–∫—Ü–∏–∏')
        bot.register_next_step_handler(mesg, reg4)


# @bot.callback_query_handler(func=lambda call: True)
# def callback_inlin(call):
#     if call.message:
#         if call.data == "startwatching":
#             kb = types.InlineKeyboardMarkup(row_width=2)
#             like_button = types.InlineKeyboardButton(text='‚ù§Ô∏è', callback_data='like')
#             print(0)
#             dislike_button = types.InlineKeyboardButton(text='‚õîÔ∏è', callback_data='dislike')
#             kb.add(like_button, dislike_button)
#             see_matchs = types.InlineKeyboardButton(text='–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏', callback_data='ismatchs')
#             kb.add(see_matchs)
#             u2 = find_friend(call.message.chat.id)
#             print(1)
#             file_info = bot.get_file(u2.photo)
#             filepath = file_info.file_path
#             last_like.update({call.message.chat.id: u2.id})
#             bot.send_photo(call.message.chat.id, get(f'http://api.telegram.org/file/bot{bot_token}/{filepath}').content, caption=f'{u2.name}, {u2.age} \n{u2.about}', reply_markup=kb)

# @bot.callback_query_handler(func=lambda call: True)
# def callback_inli(call):
#     if call.message:
#         if call.data == 'like':
#             like(call.message.chat.id, last_like[call.message.chat.id])
#             kb = types.InlineKeyboardMarkup(row_width=2)
#             like_button = types.InlineKeyboardButton(text='‚ù§Ô∏è', callback_data='like')
            
#             dislike_button = types.InlineKeyboardButton(text='‚õîÔ∏è', callback_data='dislike')
#             kb.add(like_button, dislike_button)
#             see_matchs = types.InlineKeyboardButton(text='–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏', callback_data='ismatchs')
#             kb.add(see_matchs)
#             u2 = find_friend(call.message.chat.id)
#             file_info = bot.get_file(u2.photo)
#             filepath = file_info.file_path
#             last_like.update({call.message.chat.id: u2.id})
#             bot.send_photo(call.message.chat.id, get(f'http://api.telegram.org/file/bot{bot_token}/{filepath}').content, caption=f'{u2.name}, {u2.age} \n{u2.about}', reply_markup=kb)
#         elif call.data == 'dislike':
#             kb = types.InlineKeyboardMarkup(row_width=2)
#             like_button = types.InlineKeyboardButton(text='‚ù§Ô∏è', callback_data='like')
            
#             dislike_button = types.InlineKeyboardButton(text='‚õîÔ∏è', callback_data='dislike')
#             kb.add(like_button, dislike_button)
#             see_matchs = types.InlineKeyboardButton(text='–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏', callback_data='ismatchs')
#             kb.add(see_matchs)
#             u2 = find_friend(call.message.chat.id)
#             file_info = bot.get_file(u2.photo)
#             filepath = file_info.file_path
#             last_like.update({call.message.chat.id: u2.id})
#             bot.send_photo(call.message.chat.id, get(f'http://api.telegram.org/file/bot{bot_token}/{filepath}').content, caption=f'{u2.name}, {u2.age} \n{u2.about}', reply_markup=kb)
    
# @bot.callback_query_handler(func=lambda call: True)
# def ismatch_callback(call):
#     if call.message:
#         if call.data == 'ismatchs':
#             kob = types.InlineKeyboardMarkup(row_width=1)
#             arr = is_matching(call.message.chat.id)
#             txt = ''
#             if arr:
#                 for elem in arr:
#                     kob.add(types.InlineKeyboardButton(text=f'{elem[1]}', callback_data=f'{elem[0]}'))
#                     txt = txt + elem[1] + '\n'
#             bot.send_message(call.message.chat.id, f'–°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤: {txt}', reply_markup=kob)

@bot.message_handler(commands=['changeprofile'])
def change_profile(message):
    if check_register(message.chat.id):
    
        keyboard = types.ReplyKeyboardMarkup(one_time_keyboard=True)
        butt = types.KeyboardButton(text='–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å')
        keyboard.add(butt)
        bot.send_message(message.chat.id, '–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å? –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', reply_markup=keyboard)
    else:
        bot.send_message(message.chat.id, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
        
       
@bot.message_handler(commands=['get_more_invites'])
def get_more_invites(message):
    mesg = bot.send_message(message.chat.id, '–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω:')
    bot.register_next_step_handler(mesg, get_more_invites2)

def get_more_invites2(message):
    if message.text == 'x29cv-39%32ka_!d':
        res = generate_tokens()
        bot.send_message(message.chat.id, '\n'.join(res))


@bot.callback_query_handler(func=lambda call: True)
def start_dialogue(call):
    if call.message:
        if call.data in user_arr():
            bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)
            start_dial(call.message.chat.id, int(call.data))

@bot.message_handler(commands=['stopdialog'])
def stopdialog(message):
    fr_id = cur_dial_find(message.chat.id)
    if fr_id:
        stop_dialogue(message.chat.id, fr_id[0])
        bot.send_message(message.chat.id, '–î–∏–∞–ª–æ–≥ –∑–∞–∫–æ–Ω—á–µ–Ω')
        bot.send_message(fr_id[0], '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –¥–∏–∞–ª–æ–≥')
    else:
        bot.send_message(message.chat.id, '–í—ã –Ω–∏ —Å –∫–µ–º –Ω–µ –≤–µ–¥—ë—Ç–µ –¥–∏–∞–ª–æ–≥')
    

@bot.message_handler(content_types=['text'])
def starttt(message):
    if message.text == "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è":
        global global_dict
        global register_dict
            
        if message.chat.id in global_dict:
            bot.send_message(message.chat.id, '–í—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é')
        elif message.chat.id in register_dict:
            bot.send_message(message.chat.id, '–í—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é')

        else:
                
            mesg = bot.send_message(message.chat.id, '–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é:')
            register_dict.update({message.chat.id: 1})
            bot.register_next_step_handler(mesg, reg)
    elif message.text == '–ù–∞—á–∞—Ç—å –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è':
        u2 = find_friend(message.chat.id)
        print(message.chat.id)
        if True:
            if u2:
                filepath = u2[2]

                kb = types.InlineKeyboardMarkup(row_width=2)
                like_button = types.InlineKeyboardButton(text='ü§ù', callback_data=f'like/{str(u2[0])}')

                dislike_button = types.InlineKeyboardButton(text='‚õîÔ∏è', callback_data=f'dislike/{str(u2[0])}')
                kb.add(like_button, dislike_button)
                # see_matchs = types.InlineKeyboardButton(text='–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏', callback_data='ismatchs')
                # kb.add(see_matchs)
                last_like.update({message.chat.id: u2[0]})
                print(u2)
                bot.send_photo(message.chat.id, open(f'{filepath}', 'rb'), caption=f'_{u2[1]}, {u2[4]}_ \n{u2[3]}', reply_markup=kb, parse_mode='Markdown')
            else:
                bot.send_message(message.chat.id, '—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å')
    elif message.text == "–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å":
        mesg = bot.send_message(message.chat.id, '–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é:')
        register_dict.update({message.chat.id: 1})
        bot.register_next_step_handler(mesg, reg)
    else:
        fr_id = cur_dial_find(message.chat.id)
        if fr_id:
            try:
                bot.send_message(fr_id[0], f'_{get_name(message.chat.id)}_:  {message.text}', parse_mode='Markdown')
                new_message_add(message.message_id, message.chat.id, fr_id[0], message.text)
            except:
                stop_dialogue(message.chat.id, fr_id[0])
                bot.send_message(message.chat.id, '–î–∏–∞–ª–æ–≥ –∑–∞–∫–æ–Ω—á–µ–Ω')

        else:
            bot.send_message(message.chat.id, '–í—ã –Ω–∏ —Å –∫–µ–º –Ω–µ –≤–µ–¥—ë—Ç–µ –¥–∏–∞–ª–æ–≥')


# @bot.message_handler(content_types=['text'])
# def dialogg(message):
#     fr_id = cur_dial_find(message.chat.id)
#     if fr_id:
#         bot.send_message(fr_id[0], f'{get_name(message.chat.id)}:\n{message.text}')
#         # new_message_add(message.id, message.chat.id, fr_id[0], message.text)
#     else:
#         bot.send_message(message.chat.id, '–í—ã –Ω–∏ —Å –∫–µ–º –Ω–µ –≤–µ–¥—ë—Ç–µ –¥–∏–∞–ª–æ–≥')
    
        







# bot.polling(none_stop=True)
